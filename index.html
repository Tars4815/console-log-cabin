<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ProgSIT | Happy holidays!</title>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<base target="_blank">
<link rel="stylesheet" type="text/css" href="./Qgis2threejs.css">
<style type="text/css">
#popup, #header, #layerpanel {
  left: 36px;
}
</style>
<script src="./threejs/three.min.js"></script>
<script src="./threejs/OrbitControls.js"></script>
<script src="./Qgis2threejs.js"></script>
<script src="./meshline/THREE.MeshLine.js"></script>
</head>
<body>
<div id="view">
  <div id="northarrow"></div>
  <div id="navigation"></div>
</div>

<!-- popup -->
<div id="popup">
  <div id="closebtn">&times;</div>
  <div id="popupbar"></div>
  <div id="popupbody">
    <div id="popupcontent"></div>

    <!-- query result -->
    <div id="queryresult">
      <table id="qr_coords_table">
        <caption>Clicked coordinates <div id="zoomtopoint" class="action-zoom zoombtn"></div></caption>
        <tr><td id="qr_coords"></td></tr>
      </table>

      <table id="qr_layername_table">
        <caption>Layer <div id="zoomtolayer" class="action-zoom zoombtn"></div></caption>
        <tr><td id="qr_layername"></td></tr>
      </table>

      <table id="qr_attrs_table">
        <caption>Attributes</caption>
      </table>

      <!-- camera actions and measure tool -->
      <div id="orbitbtn" class="action-btn action-orbit">Orbit</div>
      <div id="measurebtn" class="action-btn">Measure distance</div>
    </div>

    <!-- page info -->
    <div id="pageinfo">
      <h1>Current View URL</h1>
      <div><input id="urlbox" type="text"></div>

      <h1>Usage</h1>
      <table id="usage">
        <tr><td colspan="2" class="star">Mouse</td></tr>
        <tr><td>Left button + Move</td><td>Orbit</td></tr>
        <tr><td>Mouse Wheel</td><td>Zoom</td></tr>
        <tr><td>Right button + Move</td><td>Pan</td></tr>

        <tr><td colspan="2" class="star">Keys</td></tr>
        <tr><td>Arrow keys</td><td>Move Horizontally</td></tr>
        <tr><td>Shift + Arrow keys</td><td>Orbit</td></tr>
        <tr><td>Ctrl + Arrow keys</td><td>Rotate</td></tr>
        <tr><td>Shift + Ctrl + Up / Down</td><td>Zoom In / Out</td></tr>
        <tr><td>L</td><td>Toggle Label Visibility</td></tr>
        <tr><td>R</td><td>Start / Stop Orbit Animation</td></tr>
        <tr><td>W</td><td>Wireframe Mode</td></tr>
        <tr><td>Shift + R</td><td>Reset Camera Position</td></tr>
        <tr><td>Shift + S</td><td>Save Image</td></tr>
      </table>

      <h1>About</h1>
      <div id="about"><img src="./Qgis2threejs.png">
        This page was made with <a href="https://www.qgis.org/">QGIS</a> and <a href="https://github.com/minorua/Qgis2threejs">Qgis2threejs</a> plugin (version 2.8).
        <div>Powered by <a href="https://threejs.org/">three.js</a>
        <span id="lib_proj4js"> and <a href="https://trac.osgeo.org/proj4js/">Proj4js</a></span>.</div>
      </div>
    </div>
  </div>
</div>

<!-- progress bar -->
<div id="progress"><div id="progressbar"></div></div>

<!-- menu -->
<div id="toolbtns">
  <div id="layerbtn"></div>
  <div id="animbtn" class="hidden"></div>
  <div id="infobtn"></div>
</div>

<!-- header and footer -->
<div id="header"></div>
<div id="footer"></div>

<!-- layer panel -->
<div id="layerpanel">
  <div id="layerlist"></div>
</div>

<!-- animation -->
<div id="narrativebox" class="ef1">
  <div id="narbody">

  </div>
  <div id="nextbtn"></div>
</div>

<script>
Q3D.Config.allVisible = true;
Q3D.Config.viewpoint = {lookAt:{x:416645.9937184405,y:5092043.7999626305,z:-1.221963599188629e-14},pos:{x:418993.16448916384,y:5090581.239338388,z:2607.335180452939}};
Q3D.Config.localMode = true;

var container = document.getElementById("view"),
    app = Q3D.application,
    gui = Q3D.gui;

app.init(container);       // initialize viewer

// load the scene
app.loadSceneFile("./data/index/scene.js", function (scene) {
  // scene file has been loaded
  app.start();
}, function (scene) {
  // all relevant files have been loaded

});
</script>
<script>
/* =================================================================
   CHROME-COMPATIBLE ANIMATION SCRIPT
   Fixes: Race conditions and Event Listener timeouts
   ================================================================= */

// We define the initialization logic as a standalone function
// so we can call it immediately OR later.
function initAnimationSystem() {
    
    // PREVENT DOUBLE LOADING
    if (window.animationStarted) return;
    window.animationStarted = true;

    console.log("Starting Animation System...");

    // --- CONFIGURATION ---
    // Initialize parameters here for the scene
    var CONFIG = {
        // Name of the point layer containing the cable car points
        layerName: "Interpolated points",
        // Interval (ms) between cable car point switches
        cableCarInterval: 0.5,
        // Number of snowflakes
        snowCount: 100000,
        // Height of snow volume  
        snowHeight: 4000,
        // Falling speed of snowflakes 
        snowFallSpeed: 1   
    };

    // 1. SETUP CABLE CAR
    var pointLayer = null;
    // Case-insensitive search
    for (var id in Q3D.application.scene.mapLayers) {
        var name = Q3D.application.scene.mapLayers[id].properties.name;
        if (name.toLowerCase() === CONFIG.layerName.toLowerCase()) {
            pointLayer = Q3D.application.scene.mapLayers[id];
            break;
        }
    }

    if (!pointLayer) {
        console.error("Layer not found: " + CONFIG.layerName);
        return;
    }

    var points = pointLayer.objectGroup.children;
    if (points.length > 0) {
        // Hide all initially
        for (var i = 0; i < points.length; i++) {
            points[i].visible = false;
        }
        points[0].visible = true;
    }

    var ccIndex = 0;
    var direction = 1;
    var lastCCUpdate = 0;

    // 2. SETUP SNOW
    var snowGeo = new THREE.Geometry();
    for (var i = 0; i < CONFIG.snowCount; i++) {
        var flake = new THREE.Vector3(
            Math.random() * 4000 - 2000,
            Math.random() * 4000 - 2000,
            Math.random() * CONFIG.snowHeight
        );
        snowGeo.vertices.push(flake);
    }
    var snowMat = new THREE.PointsMaterial({ color: 0xffffff, size: 3, transparent: true, opacity: 0.7 });
    var snowSystem = new THREE.Points(snowGeo, snowMat);
    snowSystem.position.z = 200; 
    Q3D.application.scene.add(snowSystem);

    // 3. ROBUST ANIMATION LOOP (setInterval)
    // We use setInterval instead of requestAnimationFrame to force Chrome to run it
    setInterval(function() {
        var now = Date.now();

        // A. SNOW
        var verts = snowGeo.vertices;
        for(var i = 0; i < verts.length; i++) {
            var v = verts[i];
            v.z -= CONFIG.snowFallSpeed;
            if (v.z < -500) v.z = CONFIG.snowHeight;
        }
        snowGeo.verticesNeedUpdate = true;

        // B. CABLE CAR
        if (points.length > 0 && now - lastCCUpdate > CONFIG.cableCarInterval) {
            lastCCUpdate = now;
            points[ccIndex].visible = false;

            if (direction === 1) {
                if (ccIndex >= points.length - 1) { direction = -1; ccIndex--; }
                else { ccIndex++; }
            } else {
                if (ccIndex <= 0) { direction = 1; ccIndex++; }
                else { ccIndex--; }
            }
            points[ccIndex].visible = true;
        }

        // C. FORCE RENDER
        // This wakes up the viewer if Chrome paused it
        Q3D.application.render();

    }, 20); // Run every 20ms (~50 FPS)
}

// --- THE CHROME FIX ---
// Check if the scene is ALREADY loaded before adding a listener.
window.addEventListener("load", function() {
    
    // Check if Q3D exists
    if (typeof Q3D === "undefined" || !Q3D.application) return;

    // SCENARIO 1: Scene is already ready (Chrome often does this)
    if (Q3D.application.scene && Q3D.application.scene.mapLayers && Object.keys(Q3D.application.scene.mapLayers).length > 0) {
        console.log("⚡ Scene was already loaded. Starting immediately.");
        initAnimationSystem();
    } 
    // SCENARIO 2: Scene is still loading (Firefox/Slow connections)
    else {
        console.log("⏳ Waiting for scene load...");
        Q3D.application.addEventListener("sceneLoaded", initAnimationSystem);
    }
});
</script>
</body>
</html>
